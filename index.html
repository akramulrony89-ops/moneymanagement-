<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rony Money Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-static/0.321.0/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        .glass {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Balance Cards Gradient Accents */
        .card-cash { border-top: 4px solid #10b981; }   /* Emerald */
        .card-bank { border-top: 4px solid #6366f1; }   /* Indigo */
        .card-mobile { border-top: 4px solid #ec4899; } /* Pink */

        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .glass { box-shadow: none; border: 1px solid #ccc; }
            table { font-size: 11px; width: 100%; }
            th, td { border: 1px solid #94a3b8; padding: 4px; }
            /* Hide the main dashboard scrollbar in print */
            ::-webkit-scrollbar { display: none; }
        }
        .print-only { display: none; }

        /* Toast Animation */
        .toast {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen relative">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 no-print">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 text-white p-3 rounded-xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Rony Money Management</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-slate-500 text-sm">Cloud Dashboard</p>
                        <span id="connection-status" class="inline-block w-2.5 h-2.5 rounded-full bg-slate-300" title="Initializing..."></span>
                        <span id="connection-text" class="text-xs text-slate-400">Connecting...</span>
                    </div>
                </div>
            </div>
            <button onclick="window.print()" class="flex items-center gap-2 bg-slate-800 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-slate-700 transition shadow-lg shadow-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Print Current View
            </button>
        </header>

        <!-- LIVE BALANCES (Always All Time) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 no-print">
            <!-- Total -->
            <div class="glass p-5 rounded-xl bg-slate-900 text-white relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-slate-300 text-xs uppercase tracking-wider font-semibold">Current Net Worth</p>
                    <h2 id="disp-total" class="text-3xl font-bold mt-1">৳0</h2>
                </div>
            </div>
            
            <!-- Cash Wallet -->
            <div class="glass card-cash p-5 rounded-xl">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-xs uppercase font-bold">Wallet (Hand Cash)</p>
                        <h2 id="disp-cash" class="text-2xl font-bold text-emerald-700 mt-1">৳0</h2>
                    </div>
                    <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Bank -->
            <div class="glass card-bank p-5 rounded-xl">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-xs uppercase font-bold">Bank Accounts</p>
                        <h2 id="disp-bank" class="text-2xl font-bold text-indigo-700 mt-1">৳0</h2>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    </div>
                </div>
            </div>

            <!-- Mobile -->
            <div class="glass card-mobile p-5 rounded-xl">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-xs uppercase font-bold">Mobile (bKash/Nagad)</p>
                        <h2 id="disp-mobile" class="text-2xl font-bold text-pink-600 mt-1">৳0</h2>
                    </div>
                    <div class="p-2 bg-pink-50 rounded-lg text-pink-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 no-print">
            
            <!-- CONTROLS -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass p-6 rounded-2xl sticky top-6">
                    <!-- Tabs -->
                    <div class="grid grid-cols-3 gap-1 bg-slate-100 p-1 rounded-lg mb-6">
                        <button onclick="window.setMode('income')" id="tab-income" class="py-2 text-sm font-semibold rounded-md text-emerald-700 bg-white shadow-sm transition">Income</button>
                        <button onclick="window.setMode('expense')" id="tab-expense" class="py-2 text-sm font-semibold rounded-md text-slate-500 hover:text-slate-700 transition">Expense</button>
                        <button onclick="window.setMode('transfer')" id="tab-transfer" class="py-2 text-sm font-semibold rounded-md text-slate-500 hover:text-slate-700 transition">Withdraw</button>
                    </div>

                    <form id="tx-form" class="space-y-4">
                        
                        <!-- Dynamic Label -->
                        <div id="transfer-info" class="hidden bg-amber-50 border border-amber-200 text-amber-800 px-3 py-2 rounded-lg text-xs mb-2">
                            <strong>Transfer / Withdraw:</strong> Move money between accounts (e.g., Bank -> bKash).
                        </div>

                        <!-- Amount & Date -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Amount (৳)</label>
                                <input type="number" id="amount" required step="any" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                                <input type="date" id="date" required class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-400 outline-none">
                            </div>
                        </div>

                        <!-- Account Selection Logic -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label id="lbl-source" class="block text-xs font-bold text-slate-500 mb-1">Account</label>
                                <select id="account" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white focus:ring-2 focus:ring-slate-400 outline-none">
                                    <option value="Cash">Wallet (Hand Cash)</option>
                                    <option value="Bank">Bank (Card)</option>
                                    <option value="Mobile">bKash / Nagad</option>
                                </select>
                            </div>
                            <!-- Only visible for Transfers -->
                            <div id="target-div" class="hidden">
                                <label class="block text-xs font-bold text-slate-500 mb-1">To (Destination)</label>
                                <select id="target-account" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white focus:ring-2 focus:ring-slate-400 outline-none">
                                    <option value="Cash">Wallet (Hand Cash)</option>
                                    <option value="Mobile">bKash / Nagad</option>
                                </select>
                            </div>
                        </div>

                        <!-- Category -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Details / Category</label>
                            <input type="text" id="category" required placeholder="Salary, Rent, ATM Withdraw..." class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-400 outline-none">
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" id="btn-submit" class="w-full py-3 rounded-lg font-bold text-white bg-emerald-600 hover:bg-emerald-700 transition shadow-lg mt-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            Add Income
                        </button>
                    </form>
                </div>
            </div>

            <!-- TABLE & REPORTS -->
            <div class="lg:col-span-8">
                <div class="glass rounded-2xl overflow-hidden min-h-[600px] flex flex-col">
                    
                    <!-- Report Toolbar -->
                    <div class="p-4 border-b bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-slate-700">Filter Report:</span>
                            <input type="month" id="month-filter" onchange="window.render()" class="px-3 py-1.5 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <button onclick="window.clearFilter()" class="text-sm text-indigo-600 hover:underline px-2">Show All</button>
                        </div>
                        <button onclick="window.confirmClear()" class="text-xs text-rose-500 font-semibold hover:bg-rose-50 px-3 py-1.5 rounded transition">Reset All Data</button>
                    </div>

                    <!-- List Header -->
                    <div class="bg-indigo-50 px-4 py-2 text-center text-indigo-800 text-sm font-medium" id="list-status">
                        Showing All Records
                    </div>

                    <div class="overflow-x-auto flex-grow">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white text-slate-500 text-xs uppercase border-b">
                                <tr>
                                    <th class="px-4 py-3">Date</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3">Type</th>
                                    <th class="px-4 py-3">Account</th>
                                    <th class="px-4 py-3 text-right">Amount</th>
                                    <th class="px-4 py-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100 text-sm text-slate-700">
                                <!-- JS Injects Here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-msg" class="p-12 text-center text-slate-400 hidden flex flex-col items-center">
                        <svg class="w-12 h-12 mb-3 opacity-20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>
                        <span>No records found.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRINT REPORT LAYOUT -->
        <div class="print-only">
            <div class="border-b-2 border-black pb-4 mb-6 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold">Rony Money Management</h1>
                    <p class="text-lg text-gray-600" id="print-title">Financial Report</p>
                </div>
                <div class="text-right">
                    <p class="text-sm">Printed on: <span id="print-date-display"></span></p>
                </div>
            </div>

            <!-- Dynamic Print Summary Box -->
            <div class="mb-8">
                <h3 class="font-bold border-b border-gray-300 mb-2 pb-1">Summary for this Period</h3>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div class="border p-3 rounded">
                        <span class="block text-gray-500">Total Income</span>
                        <strong class="text-xl text-emerald-700" id="p-period-income">৳0</strong>
                    </div>
                    <div class="border p-3 rounded">
                        <span class="block text-gray-500">Total Expense</span>
                        <strong class="text-xl text-rose-700" id="p-period-expense">৳0</strong>
                    </div>
                    <div class="border p-3 rounded bg-gray-50">
                        <span class="block text-gray-500">Net Flow</span>
                        <strong class="text-xl" id="p-period-net">৳0</strong>
                    </div>
                </div>
            </div>

            <table class="w-full">
                <thead>
                    <tr class="bg-gray-200 text-xs uppercase">
                        <th class="text-left px-2 py-1">Date</th>
                        <th class="text-left px-2 py-1">Description</th>
                        <th class="text-left px-2 py-1">Type</th>
                        <th class="text-left px-2 py-1">Method</th>
                        <th class="text-right px-2 py-1">In (+)</th>
                        <th class="text-right px-2 py-1">Out (-)</th>
                    </tr>
                </thead>
                <tbody id="print-table-body" class="text-sm divide-y divide-gray-200">
                    <!-- JS Injects Here -->
                </tbody>
            </table>
            
            <div class="mt-16 pt-8 border-t border-gray-300 flex justify-between text-xs text-gray-500">
                <p>Generated by Rony Money Management System</p>
                <div class="text-center w-48">
                    <div class="border-b border-black mb-1"></div>
                    <p>Authorized Signature</p>
                </div>
            </div>
        </div>

    </div>

    <!-- UI COMPONENTS (Toast & Modal) -->
    <div id="toast" class="toast fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50">
        <span id="toast-icon"></span>
        <span id="toast-msg">Notification</span>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 relative z-10 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-slate-900 mb-2">Confirm Action</h3>
            <p id="modal-msg" class="text-slate-600 mb-6 text-sm">Are you sure you want to do this?</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closeModal()" class="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-100 font-medium text-sm">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 font-medium text-sm">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let user = null;
        let transactions = [];
        let unsubscribe = null;
        let currentMode = 'income';
        let db = null;
        let appId = 'default-app';
        let isCloudEnabled = false;

        // --- UI HELPERS ---
        const showToast = (msg, type = 'success') => {
            const el = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            document.getElementById('toast-msg').innerText = msg;
            
            if(type === 'success') {
                el.className = "toast fixed bottom-6 right-6 bg-emerald-700 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50";
                icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            } else if (type === 'error') {
                el.className = "toast fixed bottom-6 right-6 bg-rose-700 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50";
                icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
            }

            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3500);
        };

        window.closeModal = () => {
            document.getElementById('confirm-modal').classList.add('hidden');
        };

        const openModal = (msg, onConfirm) => {
            document.getElementById('modal-msg').innerText = msg;
            const btn = document.getElementById('modal-confirm-btn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn); // Clear old listeners
            newBtn.onclick = () => {
                onConfirm();
                window.closeModal();
            };
            document.getElementById('confirm-modal').classList.remove('hidden');
        };

        // --- UI LOGIC (Bound to Window) ---
        window.setMode = (mode) => {
            currentMode = mode;
            const tabInc = document.getElementById('tab-income');
            const tabExp = document.getElementById('tab-expense');
            const tabTra = document.getElementById('tab-transfer');
            const lblSource = document.getElementById('lbl-source');
            const targetDiv = document.getElementById('target-div');
            const transferInfo = document.getElementById('transfer-info');
            const accountSelect = document.getElementById('account');
            const targetSelect = document.getElementById('target-account');
            const submitBtn = document.getElementById('btn-submit');

            // Reset styles
            [tabInc, tabExp, tabTra].forEach(t => {
                t.className = "py-2 text-sm font-semibold rounded-md text-slate-500 hover:text-slate-700 transition";
            });

            // Active Style & Logic
            if(mode === 'income') {
                tabInc.className = "py-2 text-sm font-semibold rounded-md text-emerald-700 bg-white shadow-sm transition";
                submitBtn.className = "w-full py-3 rounded-lg font-bold text-white bg-emerald-600 hover:bg-emerald-700 transition shadow-lg mt-2";
                submitBtn.innerText = "Add Income (+)";
                lblSource.innerText = "Deposit To";
                targetDiv.classList.add('hidden');
                transferInfo.classList.add('hidden');
                
                accountSelect.innerHTML = `
                    <option value="Cash">Wallet (Hand Cash)</option>
                    <option value="Bank">Bank (Card)</option>
                    <option value="Mobile">bKash / Nagad</option>
                `;
            } 
            else if(mode === 'expense') {
                tabExp.className = "py-2 text-sm font-semibold rounded-md text-rose-700 bg-white shadow-sm transition";
                submitBtn.className = "w-full py-3 rounded-lg font-bold text-white bg-rose-600 hover:bg-rose-700 transition shadow-lg mt-2";
                submitBtn.innerText = "Add Expense (-)";
                lblSource.innerText = "Paid From";
                targetDiv.classList.add('hidden');
                transferInfo.classList.add('hidden');
                
                accountSelect.innerHTML = `
                    <option value="Cash">Wallet (Hand Cash)</option>
                    <option value="Bank">Bank (Card)</option>
                    <option value="Mobile">bKash / Nagad</option>
                `;
            }
            else if(mode === 'transfer') {
                tabTra.className = "py-2 text-sm font-semibold rounded-md text-amber-700 bg-white shadow-sm transition";
                submitBtn.className = "w-full py-3 rounded-lg font-bold text-white bg-amber-600 hover:bg-amber-700 transition shadow-lg mt-2";
                submitBtn.innerText = "Transfer Funds";
                lblSource.innerText = "From (Source)";
                targetDiv.classList.remove('hidden');
                transferInfo.classList.remove('hidden');

                accountSelect.innerHTML = `
                    <option value="Bank">Bank Account</option>
                    <option value="Mobile">bKash / Nagad</option>
                    <option value="Cash">Wallet (Hand Cash)</option>
                `;
                targetSelect.innerHTML = `
                    <option value="Cash">Wallet (Hand Cash)</option>
                    <option value="Mobile">bKash / Nagad</option>
                    <option value="Bank">Bank Account</option>
                `;
            }
        };

        window.clearFilter = () => {
            document.getElementById('month-filter').value = "";
            window.render();
        };

        window.deleteTx = (id) => {
            if(!isCloudEnabled) { showToast("Cloud inactive", 'error'); return; }
            openModal("This action cannot be undone. Delete this record?", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id));
                    showToast("Record deleted");
                } catch(e) {
                    console.error(e);
                    showToast("Failed to delete", 'error');
                }
            });
        };

        window.confirmClear = () => {
            if(!isCloudEnabled) { showToast("Cloud inactive", 'error'); return; }
            openModal("DANGER: This will wipe ALL your financial history permanently. Continue?", async () => {
                const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
                const snap = await getDocs(colRef);
                const batch = writeBatch(db);
                snap.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                showToast("All data cleared");
            });
        };

        window.render = () => {
            const tbody = document.getElementById('table-body');
            const pbody = document.getElementById('print-table-body');
            const emptyMsg = document.getElementById('empty-msg');
            const monthFilter = document.getElementById('month-filter');
            const listStatus = document.getElementById('list-status');
            const printTitle = document.getElementById('print-title');
            
            tbody.innerHTML = '';
            pbody.innerHTML = '';

            let balCash = 0;
            let balBank = 0;
            let balMobile = 0;

            // 1. Calculate Balances
            transactions.forEach(t => {
                if(t.mode === 'income') {
                    if(t.account === 'Cash') balCash += t.amount;
                    if(t.account === 'Bank') balBank += t.amount;
                    if(t.account === 'Mobile') balMobile += t.amount;
                } 
                else if(t.mode === 'expense') {
                    if(t.account === 'Cash') balCash -= t.amount;
                    if(t.account === 'Bank') balBank -= t.amount;
                    if(t.account === 'Mobile') balMobile -= t.amount;
                }
                else if(t.mode === 'transfer') {
                    if(t.account === 'Bank') balBank -= t.amount;
                    if(t.account === 'Mobile') balMobile -= t.amount;
                    if(t.account === 'Cash') balCash -= t.amount;

                    const dest = t.target || 'Cash';
                    if(dest === 'Cash') balCash += t.amount;
                    if(dest === 'Bank') balBank += t.amount;
                    if(dest === 'Mobile') balMobile += t.amount;
                }
            });

            // Update Header Stats
            const formatMoney = (n) => '৳' + n.toLocaleString('en-BD', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            document.getElementById('disp-total').textContent = formatMoney(balCash + balBank + balMobile);
            document.getElementById('disp-cash').textContent = formatMoney(balCash);
            document.getElementById('disp-bank').textContent = formatMoney(balBank);
            document.getElementById('disp-mobile').textContent = formatMoney(balMobile);

            // 2. Filter & Sort
            const filterVal = monthFilter.value;
            let filteredTx = [...transactions];

            if (filterVal) {
                filteredTx = filteredTx.filter(t => t.date.startsWith(filterVal));
                const [y, m] = filterVal.split('-');
                const dateObj = new Date(y, m - 1);
                const monthName = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
                listStatus.textContent = `Displaying Report for: ${monthName}`;
                printTitle.textContent = `Monthly Report - ${monthName}`;
            } else {
                listStatus.textContent = "Displaying All Transactions";
                printTitle.textContent = "Full Financial History Report";
            }
            
            filteredTx.sort((a,b) => new Date(b.date) - new Date(a.date));

            // 3. Render Rows
            if(filteredTx.length === 0) emptyMsg.classList.remove('hidden');
            else emptyMsg.classList.add('hidden');

            let periodInc = 0;
            let periodExp = 0;

            filteredTx.forEach(t => {
                if(t.mode === 'income') periodInc += t.amount;
                if(t.mode === 'expense') periodExp += t.amount;

                let typeBadge = '';
                let amtColor = '';
                let accDisplay = '';
                let printIn = '-';
                let printOut = '-';

                if(t.mode === 'income') {
                    typeBadge = `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-xs font-bold">Income</span>`;
                    amtColor = 'text-emerald-600 font-bold';
                    accDisplay = `To: ${t.account}`;
                    printIn = formatMoney(t.amount);
                } else if (t.mode === 'expense') {
                    typeBadge = `<span class="bg-rose-100 text-rose-700 px-2 py-0.5 rounded text-xs font-bold">Expense</span>`;
                    amtColor = 'text-rose-600 font-bold';
                    accDisplay = `From: ${t.account}`;
                    printOut = formatMoney(t.amount);
                } else {
                    typeBadge = `<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs font-bold">Transfer</span>`;
                    amtColor = 'text-amber-600 font-bold';
                    accDisplay = `${t.account} ➜ ${t.target || 'Cash'}`;
                    printOut = `(${formatMoney(t.amount)})`; 
                }

                // Screen Row
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-50";
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-slate-500">${t.date}</td>
                    <td class="px-4 py-3 font-medium text-slate-800">${t.category}</td>
                    <td class="px-4 py-3">${typeBadge}</td>
                    <td class="px-4 py-3 text-slate-600 text-xs">${accDisplay}</td>
                    <td class="px-4 py-3 text-right ${amtColor}">${t.mode === 'expense' ? '-' : ''}${formatMoney(t.amount)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="window.deleteTx('${t.id}')" class="text-slate-300 hover:text-rose-500 font-bold px-2 hover:bg-slate-100 rounded">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Print Row
                const ptr = document.createElement('tr');
                ptr.innerHTML = `
                    <td class="px-2 py-1">${t.date}</td>
                    <td class="px-2 py-1">${t.category}</td>
                    <td class="px-2 py-1 capitalize text-xs">${t.mode}</td>
                    <td class="px-2 py-1 text-xs text-gray-500">${accDisplay.replace('➜', 'to')}</td>
                    <td class="px-2 py-1 text-right text-emerald-800">${printIn}</td>
                    <td class="px-2 py-1 text-right text-rose-800">${printOut}</td>
                `;
                pbody.appendChild(ptr);
            });

            // Update Period Stats
            document.getElementById('p-period-income').textContent = formatMoney(periodInc);
            document.getElementById('p-period-expense').textContent = formatMoney(periodExp);
            const net = periodInc - periodExp;
            const netEl = document.getElementById('p-period-net');
            netEl.textContent = (net >= 0 ? '+' : '') + formatMoney(net);
            netEl.className = `text-xl font-bold ${net >= 0 ? 'text-emerald-700' : 'text-rose-700'}`;
            document.getElementById('print-date-display').textContent = new Date().toLocaleString();
        };

        // --- FIREBASE INIT ---
        const init = async () => {
            const statusEl = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            try {
                if(typeof __firebase_config === 'undefined' || !__firebase_config) {
                    throw new Error("Config Missing");
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';
                
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                // Auth
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        isCloudEnabled = true;
                        statusEl.className = "inline-block w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                        statusText.textContent = "Secure Cloud Active";
                        statusText.className = "text-xs text-emerald-600 font-medium";
                        
                        // Listener
                        unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), (snapshot) => {
                            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.render();
                        }, (err) => {
                            console.error("Sync Error:", err);
                            showToast("Sync paused", 'error');
                        });
                    }
                });

            } catch (err) {
                console.error("Initialization Failed:", err);
                isCloudEnabled = false;
                statusEl.className = "inline-block w-2.5 h-2.5 rounded-full bg-rose-500";
                statusText.textContent = "Offline / Local Mode";
                statusText.className = "text-xs text-rose-500 font-medium";
                showToast("Cloud features disabled (Config missing)", 'error');
                
                // Allow UI to function slightly in read-only mode or just fail gracefully
                window.render(); 
            }
        };

        // --- FORM HANDLING ---
        document.getElementById('tx-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            
            if (!isCloudEnabled || !user) {
                showToast("Cannot save: Cloud unconnected", 'error');
                return;
            }

            // Lock UI
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerText = "Saving...";

            try {
                const amountVal = parseFloat(document.getElementById('amount').value);
                const dateVal = document.getElementById('date').value;
                
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), {
                    mode: currentMode,
                    amount: amountVal,
                    date: dateVal,
                    category: document.getElementById('category').value,
                    account: document.getElementById('account').value,
                    target: currentMode === 'transfer' ? document.getElementById('target-account').value : null,
                    timestamp: new Date().toISOString()
                });

                showToast("Transaction saved!", 'success');
                document.getElementById('category').value = '';
                document.getElementById('amount').value = '';
                // Keep date & mode
            } catch(err) {
                console.error(err);
                showToast("Failed to save data", 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // Start
        document.getElementById('date').valueAsDate = new Date();
        window.setMode('income'); // Init UI immediately
        init(); // Start Async DB connect

    </script>
</body>
</html>
